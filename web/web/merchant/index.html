<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Foody ¬∑ –õ–ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</title>
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/filepond@^4/dist/filepond.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/filepond-plugin-image-preview@^4/dist/filepond-plugin-image-preview.min.css" />
<!-- Flatpickr & FilePond libs for "–°–æ–∑–¥–∞—Ç—å" –≤–∫–ª–∞–¥–∫–∞ -->
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  <script defer src="https://unpkg.com/filepond-plugin-image-preview@^4/dist/filepond-plugin-image-preview.min.js"></script>
  <script defer src="https://unpkg.com/filepond-plugin-file-validate-type@^1/dist/filepond-plugin-file-validate-type.min.js"></script>
  <script defer src="https://unpkg.com/filepond-plugin-file-validate-size@^2/dist/filepond-plugin-file-validate-size.min.js"></script>
  <script defer src="https://unpkg.com/filepond@^4/dist/filepond.min.js"></script>
  <!-- FOODY API fallback for new.html compatibility -->
  <script>window.foodyApi = (window.__FOODY__ && window.__FOODY__.FOODY_API) || window.foodyApi || 'https://foodyback-production.up.railway.app';</script>
  <script defer src="/config.js"></script>
  <script defer src="/web/merchant/app.js?v=1755273592"></script>
  <script defer src="./create.enhance.js"></script>
<!-- FOODY HARD LOGOUT + GATE -->
  <script>
    (function(){
      try {
        var qs = new URLSearchParams(location.search);
        if (qs.get('logout') === '1') {
          try { Object.keys(localStorage).forEach(function(k){ if(/^foody_/i.test(k)) localStorage.removeItem(k); }); } catch(e){}
          try { history.replaceState(null,'', location.pathname); } catch(e){}
          location.reload();
          return;
        }
        var rid = localStorage.getItem('foody_restaurant_id') || '';
        var key = localStorage.getItem('foody_key') || '';
        var authed = !!(rid && key);
        var tabs = document.getElementById('tabs');
        var bn = document.querySelector('.bottom-nav');
        var lo = document.getElementById('logoutBtn');
        if (!authed) {
          if (tabs) tabs.style.display = 'none';
          if (bn) bn.style.display = 'none';
          if (lo) lo.style.display = 'none';
          try {
            document.querySelectorAll('.pane').forEach(function(p){ p.classList.remove('active'); });
            var auth = document.getElementById('auth'); if (auth) auth.classList.add('active');
          } catch(_) {}
        } else {
          if (tabs) tabs.style.display = '';
          if (bn) bn.style.display = '';
          if (lo) lo.style.display = '';
        }
      } catch (e) {}
    })();
  </script>
</head>
<body>
  <div class="app">
    <header class="tg-header">
      <div class="tg-header__left">
        <div class="avatar">üçΩÔ∏è</div>
        <div class="titles">
          <div class="title">Foody</div>
          <div class="subtitle">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        </div>
      </div>
      <div class="tg-header__right">
        <button id="logoutBtn" class="btn btn-ghost hidden">–í—ã–π—Ç–∏</button>
      </div>
    </header>

    <nav class="segmented" id="tabs">
      <button class="seg-btn active" data-tab="dashboard">–î–∞—à–±–æ—Ä–¥</button>
      <button class="seg-btn" data-tab="offers">–û—Ñ—Ñ–µ—Ä—ã</button>
      <button class="seg-btn" data-tab="create">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="seg-btn" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
      <button class="seg-btn" data-tab="export">–≠–∫—Å–ø–æ—Ä—Ç</button>
    </nav>

    <main class="content">
      <!-- AUTH -->
      <section class="pane" id="auth">
        <div class="card card-glass">
          <div class="card-title">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</div>
          <div class="grid two">
            <div class="card">
              <div class="card-subtitle">1) –°–æ–∑–¥–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω</div>
              <form id="registerForm" class="form">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ
                  <input name="name" placeholder="–ö–∞—Ñ–µ –ü–ª—é—Å" required>
                </label>
                <label>–¢–µ–ª–µ—Ñ–æ–Ω
                  <input name="phone" placeholder="+7 900 123-45-67" required>
                </label>
                <button class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
              </form>
            </div>
            <div class="card">
              <div class="card-subtitle">2) –í–æ–π—Ç–∏ –ø–æ –¥–∞–Ω–Ω—ã–º</div>
              <form id="loginForm" class="form">
                <label>Restaurant ID
                  <input name="restaurant_id" placeholder="RID_..." required>
                </label>
                <label>API Key
                  <input name="api_key" placeholder="KEY_..." required>
                </label>
                <button class="btn btn-primary">–í–æ–π—Ç–∏</button>
              </form>
            </div>
          </div>
          <div class="hint">–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ <b>Restaurant ID</b> –∏ <b>API Key</b>. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section class="pane active" id="dashboard">
        <div class="stats">
          <div class="stat">
            <div class="stat-val" id="statOffers">‚Äî</div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã</div>
          </div>
          <div class="stat">
            <div class="stat-val" id="statQty">‚Äî</div>
            <div class="stat-label">–û—Å—Ç–∞—Ç–æ–∫ —à—Ç.</div>
          </div>
          <div class="stat">
            <div class="stat-val" id="statDisc">‚Äî</div>
            <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —Å–∫–∏–¥–∫–∞</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">–ë–ª–∏–∂–∞–π—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã</div>
          <div id="dashboardOffers" class="list list-cards">
            <div class="skeleton"></div>
            <div class="skeleton"></div>
            <div class="skeleton"></div>
          </div>
        </div>
      </section>

      <!-- OFFERS LIST -->
      <section class="pane" id="offers">
        <div class="card">
          <div class="card-title">–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã</div>
          <div id="offerList" class="table">
            <div class="skeleton"></div>
            <div class="skeleton"></div>
          </div>
        </div>
      </section>

      <!-- CREATE OFFER -->
      <section class="pane" id="create">
        <div class="card">
          <div class="card-title">–°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</div>
          <form id="offerForm" class="form grid two">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ
              <input name="title" placeholder="–ù–∞–ø—Ä., –ù–∞–±–æ—Ä —Å—É—à–∏ ¬´–ó–∞–∫–∞—Ç¬ª" required>
            </label>
            <label>–¶–µ–Ω–∞ (‚ÇΩ / AED)
              <input name="price" type="number" min="0" step="0.01" placeholder="–ù–∞–ø—Ä., 250" required>
            </label>
            <label>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
              <input name="original_price" type="number" min="0" step="0.01" placeholder="–ù–∞–ø—Ä., 349">
            </label>
            <label>–û—Å—Ç–∞—Ç–æ–∫ / –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, —à—Ç
              <input name="qty_total" type="number" min="1" step="1" value="1" required>
            </label>
            <label class="full">–ò—Å—Ç–µ–∫–∞–µ—Ç
              <input id="expires_at" name="expires_at" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è" required>
              <div id="quickTime" class="quick-group" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                <button type="button" class="btn-ghost quick-btn" data-mins="30">+30 –º–∏–Ω</button>
                <button type="button" class="btn-ghost quick-btn" data-mins="60">+1 —á–∞—Å</button>
                <button type="button" class="btn-ghost quick-btn" data-mins="120">+2 —á–∞—Å–∞</button>
                <button type="button" class="btn-ghost quick-btn" data-eod="21:00">–°–µ–≥–æ–¥–Ω—è 21:00</button>
                              <button type="button" class="btn-ghost quick-btn" data-close="1">–ö –∑–∞–∫—Ä—ã—Ç–∏—é</button>
              </div>
              <div class="hint">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä: 30‚Äì120 –º–∏–Ω—É—Ç, ¬´–°–µ–≥–æ–¥–Ω—è 21:00¬ª –∏–ª–∏ ¬´–ö –∑–∞–∫—Ä—ã—Ç–∏—é¬ª.</div>
              <div class="hint">–¢–∞–π–º–µ—Ä —Å–∫–∏–¥–æ–∫ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —ç—Ç–æ–π —Ç–æ—á–∫–µ.</div>
            </label>
            <label class="full">–ö–∞—Ç–µ–≥–æ—Ä–∏—è
              <select name="category">
                <option value="ready_meal">–ì–æ—Ç–æ–≤—ã–µ –±–ª—é–¥–∞</option>
  <option value="bakery">–í—ã–ø–µ—á–∫–∞</option>
  <option value="sushi">–°—É—à–∏/—Ä–æ–ª–ª—ã</option>
  <option value="salad">–°–∞–ª–∞—Ç—ã</option>
  <option value="dessert">–î–µ—Å–µ—Ä—Ç—ã</option>
  <option value="other">–î—Ä—É–≥–æ–µ</option>
              </select>
            </label>
            <label class="full">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
              <input type="file" id="photo" accept="image/*">
              <input type="hidden" name="image_url" id="image_url">
              <div class="hint">Drag&drop, –ø—Ä–µ–≤—å—é, –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞, –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞.</div>
              <div id="photoPreviewWrap" class="photo-preview hidden">
                <img id="photoPreview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" />
              </div>
            </label>
            <label class="full">
              <textarea name="description" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ: —Å–æ—Å—Ç–∞–≤, –¥–ª—è —Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ä—Ü–∏–π –∏ —Ç.–ø."></textarea>
            </label>
            <button class="btn btn-primary full">–°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</button>
          </form>
        </div></section>

      <!-- PROFILE -->
      <section class="pane" id="profile">
        <div class="card">
          <div class="card-title">–ü—Ä–æ—Ñ–∏–ª—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
          <form id="profileForm" class="form grid two">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ
              <input name="name">
            </label>
            <label>–¢–µ–ª–µ—Ñ–æ–Ω
              <input name="phone">
            </label>
            <label class="full">–ê–¥—Ä–µ—Å
              <input name="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º">
            </label>
            <label>–®–∏—Ä–æ—Ç–∞
              <input name="lat" type="number" step="0.000001">
            </label>
            <label>–î–æ–ª–≥–æ—Ç–∞
              <input name="lng" type="number" step="0.000001">
            </label>
            <label>–í—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è
              <input name="close_time" type="time">
            </label>
            <button class="btn btn-primary full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </form>
        </div>
        <div class="card">
          <div class="card-title">–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ</div>
          <pre id="profileDump" class="dump">‚Äî</pre>
        </div>
      </section>

      <!-- EXPORT -->
      <section class="pane" id="export">
        <div class="card">
          <div class="card-title">–≠–∫—Å–ø–æ—Ä—Ç CSV</div>
          <p class="muted">–°–∫–∞—á–∞–π—Ç–µ –≤—ã–≥—Ä—É–∑–∫—É —Ç–µ–∫—É—â–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤.</p>
          <button id="downloadCsv" class="btn btn-primary">–°–∫–∞—á–∞—Ç—å CSV</button>
        </div>
        <div class="card">
          <div class="card-title">–¢–µ–∫—É—â–∏–µ –∫–ª—é—á–∏</div>
          <pre id="creds" class="dump small">‚Äî</pre>
        </div>
      </section>
    </main>

    <nav class="bottom-nav">
      <button class="nav-btn active" data-tab="dashboard" title="–î–∞—à–±–æ—Ä–¥">üè†</button>
      <button class="nav-btn" data-tab="offers" title="–û—Ñ—Ñ–µ—Ä—ã">üõçÔ∏è</button>
      <button class="nav-btn fab" data-tab="create" title="–°–æ–∑–¥–∞—Ç—å">Ôºã</button>
      <button class="nav-btn" data-tab="profile" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§</button>
      <button class="nav-btn" data-tab="export" title="–≠–∫—Å–ø–æ—Ä—Ç">‚¨áÔ∏è</button>
    </nav>

    <div id="toast"></div>
  </div>
<!-- Fallback: enable tabs/gating even if app.js failed to load -->
  <script>
    (function(){
      try {
        function $$ (s, r){ return Array.from((r||document).querySelectorAll(s)); }
        function activateTab(tab){
          $$('.seg-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
          $$('.pane').forEach(p => p.classList.toggle('active', p.id === tab));
        }
        // Click delegation for top segmented tabs
        var tabs = document.getElementById('tabs');
        if (tabs) {
          tabs.addEventListener('click', function(e){
            var btn = e.target.closest && e.target.closest('.seg-btn');
            if (!btn) return;
            var tab = btn.getAttribute('data-tab');
            if (tab) activateTab(tab);
          }, { passive: true });
        }
        // Basic gate based on localStorage
        var rid = localStorage.getItem('foody_restaurant_id') || '';
        var key = localStorage.getItem('foody_key') || '';
        if (!rid || !key) {
          activateTab('auth');
          if (tabs) tabs.style.display = 'none';
          var bn = document.querySelector('.bottom-nav'); if (bn) bn.style.display = 'none';
        } else {
          activateTab('dashboard');
        }
        console.log('[Foody] Fallback tabs initialized');
      } catch (e) {
        console.warn('[Foody] Fallback init error', e);
      }
    })();
  </script>
</body>
</html>
